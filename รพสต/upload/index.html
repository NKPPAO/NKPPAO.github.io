<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบอัปโหลดไฟล์โรงพยาบาล</title>
  <style>
    body {margin:0;font-family:sans-serif;display:flex;}
    .sidebar {width:250px;background:#f4f4f4;padding:10px;border-right:1px solid #ccc;height:100vh;overflow-y:auto;}
    .sidebar h3 {margin-top:0;}
    .sidebar ul {list-style:none;padding:0;}
    .sidebar li {padding:6px;cursor:pointer;border-bottom:1px solid #ddd;}
    .sidebar li:hover {background:#e0e0e0;}
    .sidebar li.uploaded {color:green;font-weight:bold;}
    .content {flex:1;padding:20px;}
    .dropzone {border:2px dashed #999;border-radius:10px;padding:40px;text-align:center;color:#777;cursor:pointer;transition:background 0.3s;}
    .dropzone.dragover {background:#e6f7ff;border-color:#3399ff;color:#3399ff;}
    #toast {visibility:hidden;min-width:200px;background:#333;color:#fff;text-align:center;border-radius:4px;padding:10px;position:fixed;z-index:1;left:50%;bottom:30px;transform:translateX(-50%);}
    #toast.show {visibility:visible;animation:fadein 0.5s, fadeout 0.5s 2.5s;}
    @keyframes fadein {from{bottom:0;opacity:0;}to{bottom:30px;opacity:1;}}
    @keyframes fadeout {from{bottom:30px;opacity:1;}to{bottom:0;opacity:0;}}
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>รายชื่อโรงพยาบาล</h3>
    <ul id="hospitalList"></ul>
  </div>

  <div class="content">
    <h2>อัปโหลดไฟล์</h2>
    <form id="uploadForm" target="hidden_iframe" method="post" enctype="multipart/form-data"
      action="YOUR_WEB_APP_URL_HERE">
      <input type="hidden" id="hospitalId" name="hospitalId">
      <label>โรงพยาบาล:</label><br>
      <input type="text" id="hospitalName" name="hospitalName" readonly><br><br>
      <div class="dropzone" id="dropzone">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</div>
      <input type="file" id="fileInput" name="file" style="display:none"><br><br>
      <button type="submit">อัปโหลด</button>
    </form>
    <iframe name="hidden_iframe" style="display:none;"></iframe>
  </div>

  <div id="toast"></div>

  <script>
    const hospitalList = document.getElementById("hospitalList");
    const hospitalIdInput = document.getElementById("hospitalId");
    const hospitalNameInput = document.getElementById("hospitalName");
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const uploadForm = document.getElementById("uploadForm");
    const toast = document.getElementById("toast");

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw-_P9n2Qyf_QgFSVOrNZ5WWQAsrXEY2DRhpmeaJvtZIM7O4LN4_nL4AVqEO-tklfz3_A/exec"; // URL deploy จาก Apps Script

    // JSONP โหลดรายชื่อรพ.
    function loadHospitals() {
      const cb = "cb" + Date.now();
      window[cb] = function(res) {
        if (res.ok) {
          res.hospitals.forEach(h => {
            const li = document.createElement("li");
            li.textContent = h.hospitalName;
            if (h.status === "uploaded") li.classList.add("uploaded");
            li.onclick = () => {
              hospitalIdInput.value = h.id;
              hospitalNameInput.value = h.hospitalName;
            };
            hospitalList.appendChild(li);
          });
        } else {
          alert("โหลดรายชื่อไม่สำเร็จ");
        }
      };
      const s = document.createElement("script");
      s.src = WEB_APP_URL + "?action=list&callback=" + cb;
      document.body.appendChild(s);
    }

    // dropzone
    dropzone.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("dragover", e => {e.preventDefault();dropzone.classList.add("dragover");});
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      fileInput.files = e.dataTransfer.files;
      if (fileInput.files.length > 0) dropzone.textContent = "เลือกไฟล์แล้ว: " + fileInput.files[0].name;
    });
    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) dropzone.textContent = "เลือกไฟล์แล้ว: " + fileInput.files[0].name;
      else dropzone.textContent = "ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์";
    });

    function showToast(msg) {
      toast.textContent = msg;
      toast.className = "show";
      setTimeout(() => {toast.className = toast.className.replace("show", "");}, 3000);
    }

    uploadForm.addEventListener("submit", e => {
      if (!hospitalIdInput.value) {
        e.preventDefault(); alert("กรุณาเลือกโรงพยาบาล"); return;
      }
      if (fileInput.files.length === 0) {
        e.preventDefault(); alert("กรุณาเลือกไฟล์"); return;
      }
      showToast("กำลังอัปโหลด...");
    });

    // ฟังผลลัพธ์จาก iframe (Apps Script postMessage)
    window.addEventListener("message", ev => {
      if (ev.data && ev.data.ok) {
        showToast("อัปโหลดเสร็จสิ้น");
        const items = hospitalList.getElementsByTagName("li");
        for (let li of items) {
          if (li.textContent === ev.data.hospitalName) {
            li.classList.add("uploaded");
          }
        }
      } else if (ev.data && !ev.data.ok) {
        showToast("ผิดพลาด: " + ev.data.message);
      }
    });

    // เริ่มโหลดรายชื่อ
    loadHospitals();
  </script>
</body>
</html>
