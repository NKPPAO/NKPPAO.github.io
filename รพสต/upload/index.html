<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡∏£‡∏û.‡∏™‡∏ï.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 9999;
    }
    #dropzone.hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-72 bg-white shadow-lg p-4 overflow-y-auto">
    <h2 class="text-lg font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏û.‡∏™‡∏ï.</h2>
    <ul id="sidebar" class="space-y-2 text-sm"></ul>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-8">
    <h1 class="text-2xl font-bold mb-6">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h1>

    <!-- Select hospital -->
    <label class="block mb-2 text-sm font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ï‡∏≥‡∏ö‡∏•</label>
    <select id="hospitalSelect" class="w-full border rounded-lg p-2 mb-4"></select>

    <!-- Dropzone -->
    <div id="dropzone" 
         class="border-2 border-dashed border-gray-400 rounded-lg p-10 text-center text-gray-600 cursor-pointer">
      <p>‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
      <input type="file" id="fileInput" class="hidden" />
    </div>
  </main>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw-_P9n2Qyf_QgFSVOrNZ5WWQAsrXEY2DRhpmeaJvtZIM7O4LN4_nL4AVqEO-tklfz3_A/exec"; // <= ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20 MB

    let hospitals = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•
    function loadHospitals() {
      const script = document.createElement("script");
      script.src = `${GAS_WEB_APP_URL}?action=list&callback=renderHospitals`;
      document.body.appendChild(script);
    }

    // Render ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏•‡∏á Sidebar ‡πÅ‡∏•‡∏∞ Dropdown
    function renderHospitals(response) {
      if (!response.ok) return alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      hospitals = response.hospitals;

      // Sidebar
      const sidebar = document.getElementById("sidebar");
      sidebar.innerHTML = hospitals.map(h => `
        <li class="flex justify-between items-center p-2 rounded hover:bg-gray-100 cursor-pointer"
            onclick="selectHospital(${h.id})">
          <span>${h.hospitalName}</span>
          <span class="text-sm">${h.status ? "‚úî" : "‚ùå"}</span>
        </li>
      `).join("");

      // Dropdown
      const select = document.getElementById("hospitalSelect");
      select.innerHTML = hospitals.map(h =>
        `<option value="${h.id}">${h.hospitalName}</option>`
      ).join("");
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏û. ‡∏à‡∏≤‡∏Å Sidebar ‚Üí set dropdown
    function selectHospital(id) {
      document.getElementById("hospitalSelect").value = id;
    }

    // Upload file
    function handleUpload(files) {
      if (!files.length) return;

      const file = files[0];
      if (file.size > MAX_FILE_SIZE) {
        return alert("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (20 MB)");
      }

      const hospitalId = document.getElementById("hospitalSelect").value;
      if (!hospitalId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•");

      const formData = new FormData();
      formData.append("action", "upload");
      formData.append("hospitalId", hospitalId);
      formData.append("file", file);

      showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...");

      fetch(GAS_WEB_APP_URL, { method: "POST", body: formData })
        .then(res => res.json())
        .then(res => {
          if (res.ok) {
            showToast("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ");
            loadHospitals(); // refresh status
          } else {
            alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + res.error);
          }
        })
        .catch(err => alert("Error: " + err));
    }

    // Toast
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 3000);
    }

    // Dropzone
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");

    dropzone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", e => handleUpload(e.target.files));

    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("hover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("hover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("hover");
      handleUpload(e.dataTransfer.files);
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏û.
    loadHospitals();
  </script>
</body>
</html>
