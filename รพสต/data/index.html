<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ข้อมูลโรงพยาบาลส่งเสริมสุขภาพตำบล สังกัด อบจ.นครปฐม</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family:'Sarabun', sans-serif; }
</style>
</head>
<body class="bg-blue-100 flex h-screen">

<!-- Sidebar -->
<div class="w-1/3 p-4 overflow-y-auto">
  <h3 class="text-xl font-bold text-blue-900 mb-4">รายการโรงพยาบาลส่งเสริมสุขภาพตำบล</h3>
  <div class="mb-4 text-sm flex items-center gap-4">
    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-red-500"></div><span>ยังไม่กรอกข้อมูล</span></div>
    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-yellow-400"></div><span>กรอกข้อมูลไม่ครบ</span></div>
    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-green-500"></div><span>กรอกข้อมูลครบ</span></div>
  </div>
  <div id="hospitalList" class="space-y-2"></div>
</div>

<!-- Form -->
<div class="w-2/3 p-6 overflow-y-auto">
  <div class="bg-white/30 backdrop-blur-md rounded-2xl p-6 shadow-lg">
    <h3 class="text-2xl font-bold text-blue-800 mb-4">ฟอร์มกรอกข้อมูล</h3>
    <form id="hospitalForm" name="hospitalForm" class="space-y-4">
      <div>
        <label class="block font-semibold text-blue-700">ชื่อโรงพยาบาล</label>
        <input type="text" id="hospitalName" readonly class="w-full p-2 rounded-lg border border-blue-200 bg-white/50">
      </div>
      <div>
        <label class="block font-semibold text-blue-700">ประวัติความเป็นมา</label>
        <textarea name="history" class="w-full p-2 rounded-lg border border-blue-200 bg-white/50"></textarea>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div><label class="block font-semibold text-blue-700">เขตรับผิดชอบ</label><input type="text" name="area" class="w-full p-2 rounded-lg border"></div>
        <div><label class="block font-semibold text-blue-700">หมายเลขโทรศัพท์</label><input type="text" name="phone" class="w-full p-2 rounded-lg border"></div>
        <div><label class="block font-semibold text-blue-700">Facebook</label><input type="text" name="facebook" class="w-full p-2 rounded-lg border"></div>
      </div>

      <div id="staffContainer"><h4 class="text-lg font-semibold text-blue-800 mb-2">บุคลากร (ข้าราชการ)</h4></div>
      <button type="button" onclick="addStaff()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">เพิ่มบุคลากร</button>

      <div id="scheduleContainer" class="mt-4 p-3 bg-white/30 backdrop-blur-md rounded-xl shadow-inner">
        <h4 class="text-lg font-semibold text-blue-800 mb-2">ตารางเวลาปฏิบัติงาน</h4>
        <div class="schedule-group space-y-2">
          <input placeholder="แพทย์" class="w-full p-2 rounded-lg border">
          <input placeholder="เภสัชกร" class="w-full p-2 rounded-lg border">
          <input placeholder="ทันตแพทย์" class="w-full p-2 rounded-lg border">
        </div>
      </div>

      <button type="button" onclick="submitForm()" class="bg-blue-800 text-white px-6 py-2 rounded-xl mt-4">บันทึกข้อมูล</button>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-5 right-5 bg-blue-600 text-white px-5 py-3 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby2WfEiNUU8KX2lk6irJwafVigFDczqAcu8uSR-hwuW9Mse5IbKBFlMtZONDIURNGdH/exec";
let selectedHospital = null;

function showToast(msg, type='success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = "fixed bottom-5 right-5 px-5 py-3 rounded-lg shadow-lg transition-opacity duration-300";
  if (type==='success') toast.classList.add('bg-green-600');
  else if (type==='error') toast.classList.add('bg-red-600');
  toast.style.opacity = "1";
  setTimeout(()=>toast.style.opacity="0", 3000);
}

async function loadHospitals() {
  const res = await fetch(API_URL+"?action=getHospitals");
  const data = await res.json();
  renderHospitals(data);
}

function renderHospitals(hospitals) {
  const list = document.getElementById('hospitalList');
  list.innerHTML = '';
  hospitals.forEach(h => {
    const div = document.createElement('div');
    div.className = "p-3 rounded-xl cursor-pointer flex items-center gap-3 text-white";
    div.classList.add(h.status==='red'?'bg-red-500':h.status==='yellow'?'bg-yellow-400':'bg-green-500');
    div.innerHTML = `<span>${h.name} (${h.subdistrict}, ${h.district})</span>`;
    div.onclick = ()=>selectHospital(h);
    list.appendChild(div);
  });
}

async function selectHospital(hospital) {
  selectedHospital = hospital;
  document.getElementById('hospitalName').value = hospital.name;
  const res = await fetch(API_URL+"?action=getHospitalData&name="+encodeURIComponent(hospital.name));
  const data = await res.json();
  populateForm(data);
}

function populateForm(data) {
  const form = document.hospitalForm;
  if (!data) return;
  form.history.value = data.history||'';
  form.area.value = data.area||'';
  form.phone.value = data.phone||'';
  form.facebook.value = data.facebook||'';
}

function addStaff() {
  const div = document.createElement('div');
  div.className = "p-3 bg-white rounded mb-2";
  div.innerHTML = `
    <input placeholder="ชื่อ" class="w-full mb-1 p-2 border">
    <input placeholder="ตำแหน่ง" class="w-full mb-1 p-2 border">
    <input placeholder="ฝ่าย" class="w-full mb-1 p-2 border">
    <input type="file" class="staffFile">
  `;
  document.getElementById('staffContainer').appendChild(div);
}

async function submitForm() {
  if (!selectedHospital) return showToast("กรุณาเลือกโรงพยาบาล","error");
  const form = document.hospitalForm;
  const staffDivs = document.querySelectorAll('#staffContainer .p-3');
  const staff = [];
  for (let div of staffDivs) {
    const inputs = div.querySelectorAll('input');
    staff.push([inputs[0].value, inputs[1].value, inputs[2].value, ""]);
  }
  const scheduleInputs = document.querySelectorAll('#scheduleContainer input');
  const schedule = [[scheduleInputs[0].value, scheduleInputs[1].value, scheduleInputs[2].value]];

  const payload = {
    action: "saveData",
    hospitalName: selectedHospital.name,
    formData: {
      subdistrict: selectedHospital.subdistrict,
      district: selectedHospital.district,
      history: form.history.value,
      area: form.area.value,
      phone: form.phone.value,
      facebook: form.facebook.value,
      staff,
      schedule
    }
  };

  const res = await fetch(API_URL, {
    method:"POST",
    body: JSON.stringify(payload),
    headers: {"Content-Type":"application/json"}
  });
  const result = await res.json();
  showToast(result.message || "บันทึกสำเร็จ");
  loadHospitals();
}

loadHospitals();
</script>
</body>
</html>
